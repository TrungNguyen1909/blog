<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>matesCTF KSMASH</title><style>html body{font-family:noto sans,sans-serif;background-color:#fff}:root{--accent: purple;--border-width:  5px }</style><link rel=stylesheet href=https://trungnguyen1909.github.io/blog/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto%20Sans"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow-night.min.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/scala.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/swift.min.js></script><script>hljs.initHighlightingOnLoad();</script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script>$(document).on('click',function(){$('.collapse').collapse('hide');})</script><meta name=generator content="Hugo 0.55.6"><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-138000293-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><body><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>matesCTF KSMASH</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/blog/>Home</a></li><li><a href=/blog/post/>Posts</a></li><li><a href=/blog/tags/>Tags</a></li></ul><ul class="nav navbar-nav navbar-right"><li class=navbar-icon><a href=https://github.com/TrungNguyen1909/><i class="fa fa-github"></i></a></li></ul></div></div></nav><main><div class=item><h4><a href=/blog/vi/post/matesctf/KSMASH/>matesCTF KSMASH</a></h4><h5>February 18, 2019</h5><a href=https://trungnguyen1909.github.io/blog/tags/matesCTF><kbd class=item-tag>matesCTF</kbd></a>
<a href=https://trungnguyen1909.github.io/blog/tags/CTF><kbd class=item-tag>CTF</kbd></a>
<a href=https://trungnguyen1909.github.io/blog/tags/pwn><kbd class=item-tag>pwn</kbd></a>
<a href=https://trungnguyen1909.github.io/blog/tags/kernel><kbd class=item-tag>kernel</kbd></a>
<a href=https://trungnguyen1909.github.io/blog/tags/linux><kbd class=item-tag>linux</kbd></a></div><h4>Translation</h4><ul><li><a href=https://trungnguyen1909.github.io/blog/post/matesctf/KSMASH/>en</a></li></ul><br><div class=text-justify><h1 id=ksmash>KSMASH</h1><h2 id=background>Background</h2><p>Đây là 1 bài exploit linux kernel module của nyaacate@gmail.com host ở vòng 3 MatesCTF 2018-2019</p><p>Bài này mình solve sau giờ :&lt; nhưng vì trước khi kết thúc CTF khoảng 2hr mà chưa mình chưa thấy team nào solved bài này cả,
nên là mình vẫn mạnh dạn gửi exploit code vào mail tác giả.</p><h2 id=challenge-description>Challenge Description</h2><p>Có một kernel module đang chạy, nhiệm vụ là từ non-root user escape lên r00t để đọc file <code>/root/flag</code></p><h2 id=reversing>Reversing</h2><p>Kernel module có tên là kmod, bạn có thể tìm thấy file executable bằng lệnh</p><pre><code>$ modinfo kmod
filename:       /lib/modules/4.18.0-15-generic/kernel/drivers/char/kmod.ko
author:         nyaacate
license:        Unlicense
srcversion:     764EF51CE35A221A02D9CA0
depends:
retpoline:      Y
name:           kmod
vermagic:       4.18.0-15-generic SMP mod_unload
</code></pre><p>mở IDA64, load kmod.ko lên, sẽ tìm thấy những điều sau</p><ul><li><p>Kernel module giao tiếp bằng file /proc/havoc</p></li><li><p>Khi đọc từ đó, kernel module sẽ ngây thơ đọc kernel memory cho chúng ta bằng hàm careless_read</p></li><li><p>Khi viết vào đó, kernel module sẽ ngây thơ viết nguyên si vào kernel memory cho chúng ta bằng hàm careless_write</p></li><li><p>Có thể thấy, 2 hàm đều đọc và viết và 1 kí tự :)</p></li><li><p>Đây là 1 bài Buffer Overflow kernel cơ bản :)</p></li></ul><h3 id=protection>Protection :</h3><ul><li><p>kASLR (kernel level Address Space Layout Randomization) : chắc là quen thuộc rồi nhỉ :) nhưng là ở kernel thôi :)</p></li><li><p>SMEP (Supervisor Mode Execution Protection) : Cơ chế bảo vệ ở CPU, không cho phép đọc instruction từ user memory :)</p></li><li><p>Kernel Stack Cookies (Canary)</p></li></ul><h2 id=exploit-vector>Exploit Vector :</h2><p><strong>Từ kernel, gọi <code>commit_creds(prepare_kernel_cred(0))</code> để lên r00t rồi trở về userspace.</strong></p><ul><li><p>Đầu tiên, chúng ta đọc kernel memory từ <code>/proc/havoc</code> để lấy thông tin</p></li><li><p>Thông tin quan trọng sẽ nằm ở offset 1</p><pre><code>	---------------------------
	|       Stack Canary       |
	---------------------------
	|       Saved RBX          |
	---------------------------
	|       Saved RBP          |
	---------------------------
	|       Saved RIP          |
	---------------------------
</code></pre></li><li><p>Như vậy, chúng ta có thể Leak và Defeat Stack Canary</p></li><li><p>Kernel ASLR defeated bằng cách tính offset từ RIP</p></li><li><p>Công việc còn lại là ROP để lên r00t và quay về</p><ul><li><p>Trong kernel không có gadget <code>mov rdi, rax</code> để chuyển kết quả của <code>prepare_kernel_cred</code> cho <code>commit_creds</code>,
tuy nhiên, vì 1 lý do nào đó, RAX lúc đó lại sẵn = RDI nên chúng ta không cần :) (dùng kernel Debugger sẽ hiểu :))</p></li><li><p>Cuối cùng là SWAPGS xong rồi IRETQ (interrupt return) để trở về chương trình của chúng ta từ kernel</p></li></ul><p>IRETQ sẽ khôi phục lại một số register như là RIP, CS, RFLAGS, RSP, SS, cụ thể, nó sẽ pop từ stack như sau</p><p><img src=/static/img/KSMASH-01.png alt=KSMASH-01></p></li></ul><h3 id=notes-issue>Notes &amp; Issue</h3><ul><li>Chúng ta không thể để fake stack ở vị trí đầu memory page vì như vậy sẽ gây stack overflow trong kernel,<br></li></ul><p>Ta cần chọn address như là <code>0x60fffe00</code> chẳng hạn ( nói chung là đừng nhiều số 0 quá là được :))</p><ul><li>Khi mình IRETQ về, mình bị SIGSEGV ở mọi câu lệnh mà RIP trỏ vào :&lt; (IDKY),<br></li></ul><p>Thế nên mình đã làm 1 trò dirty bẩn bựa là handle signal SIGSEGV bằng 1 hàm, trong đó, mình để <code>system(&quot;/bin/sh&quot;)</code> :))</p><ul><li><p>Tất cả thông tin về cách giao tiếp &amp; những thứ khác vv thì các bạn có thể check file exploit.c</p></li><li><p>KP trên các máy &gt;= 4th Gen(Haswell) do SMAP -&gt; bypassable = ROP cr4</p></li><li><p>Solution ret2usr sẽ không qua được vì từ Linux 4.15, kernel sẽ map tất tần tần userspace memory thành NX.</p></li><li><p>SIGSEGV khi iretq cũng là do KPTI(Kernel Page Table Isolation) (a.k.a KAISER) có từ khi patch Meltdown
=&gt; Resolve bằng cách ROP CR3?</p></li></ul><h2 id=gotchas>Gotchas :)</h2><ul><li>Trong <code>/home/nyan</code> có source của kernel module :)))<br></li></ul><h2 id=reference>Reference</h2><p><a href=https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/linux-kernel-rop-ropping-your-way-to-part-1/>ROP your way to Kernel part 1</a></p><p><a href=https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/linux-kernel-rop-ropping-your-way-to-part-2/>ROP your way to Kernel part 2</a></p><p><a href=https://cyseclabs.com/slides/smep_bypass.pdf>Practical SMEP bypass techniques on Linux</a></p><p>Cả 3 đều là của tác giả Vitaly Nikolenko :O</p><p><a href=https://outflux.net/blog/archives/2018/02/05/security-things-in-linux-v4-15/>Changes in Linux Kernel</a></p></div><h4 class=page-header>File Resources</h4><ul><li><a href=https://trungnguyen1909.github.io/blog/vi/post/matesctf/KSMASH/Source/Makefile>Source/Makefile</a></li><li><a href=https://trungnguyen1909.github.io/blog/vi/post/matesctf/KSMASH/Source/Module.symvers>Source/Module.symvers</a></li><li><a href=https://trungnguyen1909.github.io/blog/vi/post/matesctf/KSMASH/Source/kmod.c>Source/kmod.c</a></li><li><a href=https://trungnguyen1909.github.io/blog/vi/post/matesctf/KSMASH/Source/modules.order>Source/modules.order</a></li><li><a href=https://trungnguyen1909.github.io/blog/vi/post/matesctf/KSMASH/exploit.c>exploit.c</a></li><ul><h4 class=page-header>Related</h4><div class=item><h4><a href=/blog/vi/post/misc/KDB/KDB/>Debug Linux Kernel trong VM</a></h4><h5>February 18, 2019</h5><a href=https://trungnguyen1909.github.io/blog/tags/debug><kbd class=item-tag>debug</kbd></a>
<a href=https://trungnguyen1909.github.io/blog/tags/kernel><kbd class=item-tag>kernel</kbd></a>
<a href=https://trungnguyen1909.github.io/blog/tags/linux><kbd class=item-tag>linux</kbd></a></div><h4 class=page-header>Comments</h4><div id=disqus_thread></div><script>(function(){var d=document,s=d.createElement('script');s.src='https://ntrung03-blog.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></main><footer><p class="copyright text-muted">&copy; All rights reserved. Powered by <a href=https://gohugo.io>Hugo</a> and <a href=https://github.com/calintat/minimal>Minimal</a></p></footer></body></html>